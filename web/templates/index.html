<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typing Practice</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <style>

        .typing-area {
            max-height: 260px;         
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        .typing-area span{
            white-space: inherit;
        }

        .pending { color: #e5e7eb; } 
        .correct { color: #4ade80; }
        .incorrect { color: #f87171; }

        .cursor {
            border-left: 2px solid #facc15;
            margin-left: -2px;
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            50% { border-color: transparent; }
        }

        #hidden-input {
            position: absolute;
            opacity: 0;
        }

        .timer {
            margin-top: 20px;
            font-size: 16px;
            color: #9ca3af;
        }
        .live-hud{
            margin-top: 14px;
            display: flex;
            gap: 24px;
            font-size: 14px;
            color:#cbd5e1;
            opacity: 0.85;
        }
        .live-hud span{
            font-weight: 600;
            color:#e5e7eb;
        }

        .footer{
            position: fixed;
            bottom: 12px;
            width:100%;
            text-align: center;
            font-size: 13px;
            color:#9ca3af;
            opacity: 0.85;
            pointer-events: auto;
        }
        .footer a{
            color:#60a5fa;
            text-decoration: none;
            font-weight: 500;
        }
        .footer a:hover {
            text-decoration: underline;
        }
        .github-icon{
            width: 16px;
            height: 16px;
            margin-left: 6px;
            vertical-align: middle;
            fill: #9ca3af;
            transition: fill 0.2s ease;
        }
        .footer a:hover .github-icon {
            fill: #60a5fa;
        }
    </style>
</head>

<body>
<div class="mobile-warning">
    ‚ö†Ô∏è TypePulse is optimized for desktop keyboards.  
    Mobile results may not reflect true typing speed.
</div>
<div class="page">
    <div class="card">

        <h1>Typing Practice</h1>
        <p class="muted">
            Type the text below exactly as shown. Focus on accuracy over speed.
        </p>

        <!-- Typing text rendered as spans -->
        <div id="typing-area" class="typing-area"></div>

        <!-- Hidden input to capture keystrokes -->
        <input id="hidden-input" autofocus>

        <!-- Timer -->
        <div class="timer">
            Time: <span id="timer">0.0</span>s
        </div>

        <!-- Live HUD-->
         <div class="live-hud">
            <div><span id="live-wpm">0</span> WPM</div>
            <div><span id="live-accuracy">100</span>% ACC</div>
         </div>

    </div>
</div>

<!-- Inject reference text -->
<script>
    const REFERENCE_TEXT = {{ reference_text | tojson }};
</script>


<script>
    let correctCharCount = 0;
    const typingArea = document.getElementById("typing-area");
    const timerEl = document.getElementById("timer");
    const liveWpmEl = document.getElementById("live-wpm");
    const liveAccEl = document.getElementById("live-accuracy");


    let currentIndex = 0;
    let startTime = null;
    let timerInterval = null;
    let typedBuffer = "";
    let finished = false;
    let wpmSamples = [];
    let lastSampleTime = null;
    let validCharCount = 0;   

    // Render reference text
    REFERENCE_TEXT.split("").forEach((char, index) => {
        const span = document.createElement("span");
        span.textContent = char;
        span.classList.add("pending");
        if (index === 0) span.classList.add("cursor");
        typingArea.appendChild(span);
    });

    function startTimer() {
        startTime = performance.now();
        timerInterval = setInterval(() => {
            const elapsed = (performance.now() - startTime) / 1000;
            timerEl.textContent = elapsed.toFixed(1);
            updateLiveStats();
        }, 100);
    }

    function updateLiveStats() {
    if (!startTime) return;

    const elapsedMinutes = (performance.now() - startTime) / 60000;
    if (elapsedMinutes <= 0) return;

    // Live WPM
    const wpm = ((validCharCount / 5) / elapsedMinutes);
    liveWpmEl.textContent = Math.round(wpm);

    // Live Accuracy
    const accuracy = typedBuffer.length === 0
        ? 100
        : (correctCharCount / typedBuffer.length) * 100;

    liveAccEl.textContent = Math.round(accuracy);
}


    function sampleWPM() {
        const now = performance.now();
        const elapsedMinutes = (now - startTime) / 60000;

        if (elapsedMinutes <= 0) return;

        const currentWPM = (validCharCount / 5) / elapsedMinutes;
         wpmSamples.push(Number(currentWPM.toFixed(2)));

        lastSampleTime = now;
}

    function finishTest() {
        finished = true; // üîí STOP INPUT
        clearInterval(timerInterval);

        const elapsedSeconds = (performance.now() - startTime) / 1000;

        fetch("/submit", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                typed_text: typedBuffer,
                elapsed_time: elapsedSeconds,
                wpm_samples:wpmSamples
            })
        })
        .then(res => res.text())
        .then(html => {
            document.open();
            document.write(html);
            document.close();
        });
    }
    function keepCursorInView(){
        const cursor = document.querySelector(".cursor");
        if (!cursor) return;
        cursor.scrollIntoView({
            behavior: "smooth",
            block: "center",
            inline: "nearest"
        });
}

    document.addEventListener("keydown", (e) => {
        if (finished) return;
        if (currentIndex >= REFERENCE_TEXT.length) return
        
        if (e.key === "Enter") return;
        e.preventDefault();

        if (!startTime) startTimer();

        const spans = typingArea.children;

        if (e.key === "Backspace") {
            if (currentIndex > 0) {
                currentIndex--;
                typedBuffer = typedBuffer.slice(0, -1);
                validCharCount=Math.max(0,validCharCount-1);
                // if last char was correct, rollback accuracy too
                if(spans[currentIndex].classList.contains("correct")){
                    correctCharCount = Math.max(0,correctCharCount - 1);
                }

                spans[currentIndex].className = "pending cursor";
                if (currentIndex + 1 < spans.length) {
                    spans[currentIndex + 1].classList.remove("cursor");
                }
                keepCursorInView();
            }
            return;
        }

        if (e.key.length !== 1) return;

        const expectedChar = spans[currentIndex].textContent;
        // Record input
        typedBuffer += e.key;
        validCharCount++;

        if (e.key == expectedChar){
            correctCharCount++;
        }
        
        // WPM sampling
        const now=performance.now();

        if(
            validCharCount % 5==0 ||
            (lastSampleTime && now -lastSampleTime >= 1000)
        ){
            sampleWPM();
        }
        
        // update UI

        spans[currentIndex].classList.remove("cursor");
        spans[currentIndex].classList.add(
            e.key === expectedChar ? "correct" : "incorrect"
        );

        currentIndex++;

        if (currentIndex < spans.length) {
            spans[currentIndex].classList.add("cursor");
            keepCursorInView();
        } else {
            finishTest();
        }
    });
</script>

<footer class="footer">
    Created by <strong>Aswin Thapa</strong>
    <a href="https://github.com/aswinthapa-py" target="_blank" rel="noopener" aria-label="GitHub profile">
        <svg class="github-icon" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 .5C5.73.5.5 5.74.5 12.02c0 5.1 3.29 9.42 7.86 10.95.58.11.79-.25.79-.56v-2.04c-3.2.7-3.88-1.38-3.88-1.38-.52-1.33-1.28-1.68-1.28-1.68-1.05-.72.08-.71.08-.71 1.16.08 1.77 1.2 1.77 1.2 1.03 1.77 2.7 1.26 3.36.96.1-.75.4-1.26.73-1.55-2.55-.29-5.23-1.28-5.23-5.7 0-1.26.45-2.29 1.19-3.1-.12-.29-.52-1.47.11-3.07 0 0 .97-.31 3.18 1.18a11.1 11.1 0 0 1 5.8 0c2.2-1.49 3.18-1.18 3.18-1.18.63 1.6.23 2.78.11 3.07.74.81 1.19 1.84 1.19 3.1 0 4.43-2.69 5.41-5.25 5.69.41.35.78 1.04.78 2.1v3.12c0 .31.21.68.8.56 4.56-1.53 7.85-5.85 7.85-10.95C23.5 5.74 18.27.5 12 .5z"/>
        </svg>
    </a>
</footer>

</body>
</html>
